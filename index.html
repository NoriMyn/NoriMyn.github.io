<script>
(() => {
  // ===========================
  //  NORI SIDEBAR v1.0
  //  Drop-in script: creates a right sidebar with downloads, links and copy buttons.
  // ===========================

  // If your site is at https://norimyn.github.io/ then baseUrl = './' is perfect.
  // If you later move files into /files/ or /assets/, change baseUrl accordingly.
  const baseUrl = './';

  const ITEMS = [
    // --- Presets
    {
      group: 'Пресеты',
      title: 'Claude miniFix (JSON)',
      desc: 'Небольшой фикс-пресет для Claude.',
      href: 'NoriMyn_Claude_miniFix.json',
      kind: 'file',
    },
    {
      group: 'Пресеты',
      title: 'Claude v2.0 (JSON)',
      desc: 'Полная/улучшенная версия Claude.',
      href: 'NoriMyn_Claudev2.0.json',
      kind: 'file',
    },
    {
      group: 'Пресеты',
      title: 'Claude (legacy) (JSON)',
      desc: 'Старая версия для совместимости.',
      href: 'NoriMyn_Claude.json',
      kind: 'file',
    },
    {
      group: 'Пресеты',
      title: 'GPT (JSON)',
      desc: 'Мощная версия для GPT.',
      href: 'NoriMyn_gpt.json',
      kind: 'file',
    },

    // --- Guide
    {
      group: 'Гайд',
      title: 'Гайд по miniFix (PDF)',
      desc: 'Открыть гайд в новой вкладке.',
      href: 'gude.pdf',
      kind: 'pdf',
    },

    // --- Regex
    {
      group: 'Regex (ST)',
      title: 'Infoblock cleanup (1gvvr0.json)',
      desc: 'Удаляет <infoblock>…</infoblock> из контекста (экономит токены).',
      href: '1gvvr0.json',
      kind: 'file',
    },
    {
      group: 'Regex (ST)',
      title: 'Bypass filter (regex-nori_bypass_filter.json)',
      desc: 'Regex обход/смягчение ограничений (как у тебя на сайте).',
      href: 'regex-nori_bypass_filter.json',
      kind: 'file',
    },
  ];

  // ---------- Helpers ----------
  const el = (tag, attrs = {}, children = []) => {
    const n = document.createElement(tag);
    for (const [k, v] of Object.entries(attrs)) {
      if (k === 'class') n.className = v;
      else if (k === 'html') n.innerHTML = v;
      else if (k.startsWith('on') && typeof v === 'function') n.addEventListener(k.slice(2), v);
      else n.setAttribute(k, v);
    }
    for (const c of (Array.isArray(children) ? children : [children])) {
      if (c == null) continue;
      n.appendChild(typeof c === 'string' ? document.createTextNode(c) : c);
    }
    return n;
  };

  const fullUrl = (href) => {
    if (/^https?:\/\//i.test(href)) return href;
    return baseUrl + href.replace(/^\.\//, '');
  };

  const toast = (() => {
    let t;
    return (msg) => {
      if (!t) {
        t = el('div', { class: 'noriToast', role: 'status', 'aria-live': 'polite' }, msg);
        document.body.appendChild(t);
      }
      t.textContent = msg;
      t.classList.add('show');
      clearTimeout(t._timer);
      t._timer = setTimeout(() => t.classList.remove('show'), 1600);
    };
  })();

  const copyText = async (text) => {
    try {
      await navigator.clipboard.writeText(text);
      toast('Скопировано');
      return true;
    } catch (_) {
      // Fallback
      const ta = el('textarea', { class: 'noriHiddenTA' }, text);
      document.body.appendChild(ta);
      ta.select();
      try {
        document.execCommand('copy');
        toast('Скопировано');
        return true;
      } catch (e) {
        toast('Не получилось скопировать :(');
        return false;
      } finally {
        ta.remove();
      }
    }
  };

  // ---------- Styles ----------
  const css = `
    :root{
      --nori-bg: rgba(15, 23, 42, 0.92);
      --nori-bg2: rgba(30, 41, 59, 0.85);
      --nori-border: rgba(148, 163, 184, 0.22);
      --nori-text: #e2e8f0;
      --nori-muted: rgba(226,232,240,0.72);
      --nori-accent: #38bdf8;
      --nori-accent2: #a78bfa;
      --nori-shadow: 0 16px 40px rgba(0,0,0,0.35);
      --nori-radius: 14px;
      --nori-w: 360px;
      --nori-font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Liberation Sans", sans-serif;
    }

    .noriSidebar{
      position: fixed;
      top: 18px;
      right: 18px;
      width: var(--nori-w);
      max-height: calc(100vh - 36px);
      display: flex;
      flex-direction: column;
      gap: 10px;
      background: var(--nori-bg);
      border: 1px solid var(--nori-border);
      border-radius: var(--nori-radius);
      box-shadow: var(--nori-shadow);
      backdrop-filter: blur(10px);
      z-index: 999999;
      overflow: hidden;
      font-family: var(--nori-font);
      color: var(--nori-text);
    }

    .noriHeader{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 14px 14px 10px 14px;
      background: linear-gradient(135deg, rgba(56,189,248,0.14), rgba(167,139,250,0.10));
      border-bottom: 1px solid var(--nori-border);
    }

    .noriTitle{
      display: flex;
      flex-direction: column;
      gap: 2px;
      line-height: 1.1;
    }
    .noriTitle strong{ font-size: 14px; letter-spacing: 0.2px; }
    .noriTitle span{ font-size: 12px; color: var(--nori-muted); }

    .noriHeaderBtns{
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .noriBtn{
      border: 1px solid var(--nori-border);
      background: rgba(2,6,23,0.45);
      color: var(--nori-text);
      border-radius: 10px;
      padding: 8px 10px;
      cursor: pointer;
      font-size: 12px;
      transition: transform .06s ease, background .12s ease, border-color .12s ease;
      user-select: none;
      white-space: nowrap;
    }
    .noriBtn:hover{ background: rgba(2,6,23,0.62); border-color: rgba(56,189,248,0.35); }
    .noriBtn:active{ transform: scale(0.98); }

    .noriBody{
      padding: 12px 12px 14px 12px;
      overflow: auto;
    }

    .noriGroup{
      margin-bottom: 12px;
      border: 1px solid var(--nori-border);
      border-radius: 12px;
      overflow: hidden;
      background: var(--nori-bg2);
    }
    .noriGroupHeader{
      padding: 10px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      cursor: pointer;
      user-select: none;
      border-bottom: 1px solid rgba(148,163,184,0.16);
    }
    .noriGroupHeader b{
      font-size: 13px;
      color: var(--nori-accent);
      letter-spacing: 0.2px;
    }
    .noriGroupHeader small{
      font-size: 12px;
      color: var(--nori-muted);
    }

    .noriGroupItems{ padding: 10px 10px 6px 10px; display: grid; gap: 10px; }
    .noriCard{
      border: 1px solid rgba(148,163,184,0.18);
      border-radius: 12px;
      padding: 10px;
      background: rgba(2,6,23,0.25);
    }
    .noriCardTop{
      display: flex;
      gap: 10px;
      align-items: flex-start;
      justify-content: space-between;
    }
    .noriCardTitle{
      font-size: 13px;
      line-height: 1.25;
      margin: 0;
      color: var(--nori-text);
    }
    .noriCardDesc{
      margin: 6px 0 0 0;
      font-size: 12px;
      color: var(--nori-muted);
      line-height: 1.3;
    }
    .noriActions{
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }
    .noriAction{
      border: 1px solid rgba(56,189,248,0.22);
      background: rgba(56,189,248,0.08);
      color: var(--nori-text);
      padding: 7px 9px;
      border-radius: 10px;
      font-size: 12px;
      cursor: pointer;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      user-select: none;
    }
    .noriAction:hover{
      background: rgba(56,189,248,0.14);
      border-color: rgba(56,189,248,0.35);
    }

    .noriMiniNote{
      margin-top: 10px;
      padding: 10px 12px;
      border: 1px dashed rgba(167,139,250,0.45);
      background: rgba(167,139,250,0.08);
      border-radius: 12px;
      color: rgba(226,232,240,0.86);
      font-size: 12px;
      line-height: 1.35;
    }

    .noriToast{
      position: fixed;
      right: 22px;
      bottom: 22px;
      background: rgba(2,6,23,0.78);
      border: 1px solid rgba(56,189,248,0.30);
      color: var(--nori-text);
      padding: 10px 12px;
      border-radius: 12px;
      box-shadow: var(--nori-shadow);
      font-family: var(--nori-font);
      font-size: 12px;
      opacity: 0;
      transform: translateY(10px);
      transition: opacity .15s ease, transform .15s ease;
      z-index: 999999;
      pointer-events: none;
    }
    .noriToast.show{ opacity: 1; transform: translateY(0); }

    .noriHiddenTA{ position: fixed; left: -9999px; top: -9999px; }

    .noriCollapsed{
      width: 56px;
    }
    .noriCollapsed .noriBody,
    .noriCollapsed .noriTitle span,
    .noriCollapsed .noriTitle strong{
      display: none;
    }
    .noriCollapsed .noriHeader{
      padding: 10px;
      justify-content: flex-end;
    }

    @media (max-width: 980px){
      .noriSidebar{ width: min(var(--nori-w), calc(100vw - 24px)); right: 12px; top: 12px; }
    }
  `;

  const style = el('style', { id: 'noriSidebarStyle' }, css);
  document.head.appendChild(style);

  // ---------- Build UI ----------
  const groups = {};
  for (const item of ITEMS) {
    const g = item.group || 'Другое';
    if (!groups[g]) groups[g] = [];
    groups[g].push(item);
  }

  const sidebar = el('aside', { class: 'noriSidebar', id: 'noriSidebar' });

  const header = el('div', { class: 'noriHeader' }, [
    el('div', { class: 'noriTitle' }, [
      el('strong', {}, 'NORI панель'),
      el('span', {}, 'быстрые ссылки / скачать / копировать'),
    ]),
    el('div', { class: 'noriHeaderBtns' }, [
      el('button', {
        class: 'noriBtn',
        title: 'Свернуть панель',
        onClick: () => sidebar.classList.toggle('noriCollapsed'),
      }, '⟷'),
      el('button', {
        class: 'noriBtn',
        title: 'Скрыть панель',
        onClick: () => {
          sidebar.remove();
          toast('Панель скрыта (обнови страницу чтобы вернуть)');
        },
      }, '✕'),
    ])
  ]);

  const body = el('div', { class: 'noriBody' });

  Object.entries(groups).forEach(([groupName, items]) => {
    const groupEl = el('section', { class: 'noriGroup' });

    const itemsWrap = el('div', { class: 'noriGroupItems' });

    items.forEach((item) => {
      const url = fullUrl(item.href);
      const title = item.title || item.href;
      const desc = item.desc || '';

      const openBtn = el('a', {
        class: 'noriAction',
        href: url,
        target: '_blank',
        rel: 'noopener',
        title: 'Открыть',
      }, 'Открыть');

      const downloadBtn = el('a', {
        class: 'noriAction',
        href: url,
        download: '',
        title: 'Скачать',
      }, 'Скачать');

      const copyBtn = el('button', {
        class: 'noriAction',
        type: 'button',
        title: 'Копировать ссылку',
        onClick: () => copyText(url),
      }, 'Копировать ссылку');

      const card = el('div', { class: 'noriCard' }, [
        el('div', { class: 'noriCardTop' }, [
          el('div', {}, [
            el('div', { class: 'noriCardTitle' }, title),
            el('div', { class: 'noriCardDesc' }, desc),
          ])
        ]),
        el('div', { class: 'noriActions' }, [
          openBtn,
          downloadBtn,
          copyBtn,
        ]),
      ]);

      itemsWrap.appendChild(card);
    });

    const groupHeader = el('div', {
      class: 'noriGroupHeader',
      onClick: () => {
        const isHidden = itemsWrap.style.display === 'none';
        itemsWrap.style.display = isHidden ? 'grid' : 'none';
        countEl.textContent = isHidden ? `${items.length} файлов` : 'свернуто';
      }
    }, [
      el('b', {}, groupName),
      el('small', {}, ''),
    ]);

    const countEl = groupHeader.querySelector('small');
    countEl.textContent = `${items.length} файлов`;

    groupEl.appendChild(groupHeader);
    groupEl.appendChild(itemsWrap);
    body.appendChild(groupEl);
  });

  body.appendChild(el('div', { class: 'noriMiniNote' }, [
    'Если переместишь файлы в папку (например /files/), просто поменяй baseUrl вверху скрипта.',
  ]));

  sidebar.appendChild(header);
  sidebar.appendChild(body);
  document.body.appendChild(sidebar);

  // ---------- Quality-of-life ----------
  // Ctrl+Shift+L toggles sidebar collapse
  window.addEventListener('keydown', (e) => {
    if (e.ctrlKey && e.shiftKey && (e.key === 'L' || e.key === 'l')) {
      e.preventDefault();
      sidebar.classList.toggle('noriCollapsed');
    }
  });

})();
</script>
